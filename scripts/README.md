# ğŸ”§ Omni Maintenance Scripts

**Location:** `scripts/` (root level, sibling to `omni/`)  
**Purpose:** One-time migrations, reconciliation, and maintenance utilities  
**Version:** 0.6.0

---

## Overview

The scripts directory contains maintenance utilities for data migration, registry reconciliation, and one-time operations. These are NOT part of the main Omni packageâ€”they're operational tools for the Architect.

**Key Difference:**
- **omni/scripts/**: Internal package scripts (part of Omni installation)
- **scripts/** (this directory): External maintenance scripts (for Architect use)

---

## Scripts

### `apply_patch_to_cmp.py` ğŸ©¹
**Purpose:** Apply registry patches to CMP database  
**Type:** One-time migration utility

**What It Does:**
- Reads patch file from `omni/artifacts/omni/project_identity.patch.json`
- Applies identity updates to CMP PostgreSQL database
- Verifies patch application with before/after comparison

**Usage:**
```powershell
# From Infrastructure root
python scripts/apply_patch_to_cmp.py

# Dry run (preview without applying)
python scripts/apply_patch_to_cmp.py --dry-run

# Apply specific patch file
python scripts/apply_patch_to_cmp.py --patch=custom_patch.json
```

**Prerequisites:**
- PostgreSQL running on localhost:5433
- `.env` file with `POSTGRES_*` credentials
- Patch file generated by `omni scan --scanners=project_identity`

**Safety Features:**
- Dry-run mode by default (requires `--apply` flag)
- Transaction-based (rolls back on error)
- Backup generation before applying
- Verification after application

**Output:**
```
ğŸ“ Loading patch: project_identity.patch.json
ğŸ” Analyzing 42 updates

Preview:
  âœï¸ Update: omni (abc-123 â†’ def-456)
  â• Add: new-project (xyz-789)
  
ğŸš« DRY RUN - No changes applied
Use --apply to execute patch
```

---

### `compare_uuid_registries.py` ğŸ”
**Purpose:** Compare UUID registries across multiple sources  
**Type:** Analysis and reconciliation tool

**What It Does:**
- Compares UUIDs across:
  - `PROJECT_REGISTRY_V1.yaml`
  - `governance/registry/uuid/canonical_uuids.json`
  - CMP PostgreSQL database
- Detects:
  - Orphans (in code but not registry)
  - Ghosts (in registry but not code)
  - Conflicts (same UUID, different projects)

**Usage:**
```powershell
# From Infrastructure root
python scripts/compare_uuid_registries.py

# Output to file
python scripts/compare_uuid_registries.py --output=uuid_comparison.json

# Include CMP database
python scripts/compare_uuid_registries.py --include-db
```

**Output:**
```
ğŸ“Š UUID Registry Comparison

Sources:
  âœ… PROJECT_REGISTRY_V1.yaml: 97 UUIDs
  âœ… canonical_uuids.json: 103 UUIDs
  âœ… CMP Database: 89 UUIDs

Overlap Analysis:
  âœ… In all 3 sources: 85 UUIDs
  âš ï¸ In 2 sources: 12 UUIDs
  ğŸ”¥ In 1 source only: 6 UUIDs

Orphans (code but not registry):
  - abc-123 (omni-temp)
  - def-456 (test-project)

Ghosts (registry but not code):
  - xyz-789 (archived-project)

Conflicts:
  - (none detected)
```

---

### `reconcile_project_identity.py` ğŸ”„
**Purpose:** Reconcile project identity across sources (The One Ring resolver)  
**Type:** Identity resolution and patching

**What It Does:**
- Implements **Policy C: Freeze & Adjudicate**
- Resolves UUID conflicts using `identity_engine`
- Generates reconciliation patches
- Applies UUIDv5 deterministic computation

**Usage:**
```powershell
# From Infrastructure root
python scripts/reconcile_project_identity.py

# Generate patch only (don't apply)
python scripts/reconcile_project_identity.py --generate-patch

# Apply reconciliation to all sources
python scripts/reconcile_project_identity.py --apply

# Reconcile specific project
python scripts/reconcile_project_identity.py --project=omni
```

**Reconciliation Rules (Policy C):**
1. **Freeze:** Stop processing on first conflict
2. **Compute:** Calculate canonical UUIDv5 from project key
3. **Compare:** Check against all sources
4. **Adjudicate:** Architect decides which to keep
5. **Patch:** Generate update for all sources

**Output:**
```
ğŸ” Scanning project identities...

Conflicts Detected:
  âš ï¸ Project: omni
    Registry:  abc-123-...
    DB:        def-456-...
    Canonical: ghi-789-... (computed)

ğŸ›‘ FREEZE: Conflict detected
Policy C requires Architect adjudication

Suggested patch:
  {
    "project": "omni",
    "action": "update",
    "from": "abc-123",
    "to": "ghi-789",
    "sources": ["registry", "db"]
  }

Review patch at: artifacts/omni/project_identity.patch.json
```

---

## Script Patterns

### Error Handling
All scripts use defensive error handling:

```python
def main():
    try:
        # Script logic
        result = do_work()
        print(f"âœ… Success: {result}")
        return 0
    except FileNotFoundError as e:
        print(f"âŒ Error: File not found: {e}")
        return 1
    except Exception as e:
        print(f"âŒ Unexpected error: {e}")
        import traceback
        traceback.print_exc()
        return 2

if __name__ == "__main__":
    sys.exit(main())
```

### Progress Reporting
Scripts provide visual progress feedback:

```python
from tqdm import tqdm

for item in tqdm(items, desc="Processing"):
    process(item)

# Or simple print
print(f"Processing {i+1}/{total}...", end="\r")
```

### Dry-Run Pattern
All destructive scripts support dry-run:

```python
def apply_changes(changes, dry_run=True):
    for change in changes:
        if dry_run:
            print(f"Would apply: {change}")
        else:
            actually_apply(change)
    
    if dry_run:
        print("\nğŸš« DRY RUN - Use --apply to execute")
```

---

## Safety Guidelines

### When to Use Scripts

âœ… **Use scripts for:**
- One-time data migrations
- Registry reconciliation after conflicts
- Database patching
- Analysis and comparison
- Emergency fixes

âŒ **Don't use scripts for:**
- Regular operations (use `omni` CLI instead)
- Automated workflows (integrate into Omni proper)
- Untested changes to production
- Bulk updates without dry-run first

### Pre-Flight Checklist

Before running any script:
1. âœ… **Backup first:** Snapshot database, copy registries
2. âœ… **Dry-run:** Always run with `--dry-run` first
3. âœ… **Review output:** Verify changes make sense
4. âœ… **Small batch:** Test on subset before full run
5. âœ… **Verify:** Check results after applying

---

## Development Guidelines

### Adding New Script

1. **Choose location:**
   - One-time operation â†’ `scripts/` (this directory)
   - Reusable feature â†’ `omni/scripts/` (package internal)

2. **Create script:**
   ```python
   #!/usr/bin/env python3
   """
   Script name - What it does
   
   Usage:
       python scripts/my_script.py [options]
   """
   import argparse
   import sys
   from pathlib import Path
   
   def main():
       parser = argparse.ArgumentParser(description="My script")
       parser.add_argument("--dry-run", action="store_true")
       args = parser.parse_args()
       
       # Script logic
       
       return 0
   
   if __name__ == "__main__":
       sys.exit(main())
   ```

3. **Document in README:** Add entry to this file

4. **Test:** Run with `--dry-run` first

5. **Version control:** Commit after successful run

---

## Script Inventory

### Current Scripts (v0.6.0)
- âœ… `apply_patch_to_cmp.py` - Apply registry patches to database
- âœ… `compare_uuid_registries.py` - Compare UUIDs across sources
- âœ… `reconcile_project_identity.py` - Resolve identity conflicts

### Planned Scripts
- ğŸ“‹ `migrate_legacy_oracle.py` - Import Oracle legacy data
- ğŸ“‹ `cleanup_orphan_artifacts.py` - Remove stale artifacts
- ğŸ“‹ `regenerate_all_registries.py` - Rebuild from ground truth
- ğŸ“‹ `verify_constitutional_compliance.py` - Full compliance audit

---

## Troubleshooting

### Common Issues

**Problem:** "Permission denied" writing to `governance/registry/`  
**Solution:** Check file permissions, run with appropriate privileges

**Problem:** "Database connection refused"  
**Solution:** Verify PostgreSQL running: `psql -h localhost -p 5433 -U postgres -d cms_db`

**Problem:** "Patch file not found"  
**Solution:** Generate patch first: `omni scan --scanners=project_identity`

**Problem:** "Conflicting UUIDs after applying patch"  
**Solution:** Run `reconcile_project_identity.py` to re-resolve

---

## Future Enhancements

### Planned (v0.7+)
- ğŸ”„ **Automatic backup creation** before script execution
- ğŸ“Š **Script execution logs** to artifacts/omni/script_runs/
- ğŸ” **Signature verification** for critical scripts
- ğŸ§ª **Test mode** with mock data
- ğŸ“ˆ **Progress tracking** for long-running scripts

---

**Maintained By:** The Architect (Kryssie) + Antigravity  
**Status:** Operational (v0.6.0)  
**Law & Lore:** Charter V1.2 compliant

let it maintain. ğŸ”§
